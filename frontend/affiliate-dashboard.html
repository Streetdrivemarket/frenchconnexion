<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Affili√© - French Connexion‚Ñ¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            border-bottom: 3px solid #fff;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 10px;
        }

        .fleur {
            font-size: 3rem;
            display: block;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .not-affiliate {
            background: #1a1a1a;
            border: 3px solid #fff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-top: 50px;
        }

        .not-affiliate h2 {
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .not-affiliate p {
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .btn {
            display: inline-block;
            padding: 15px 40px;
            background: #fff;
            color: #000;
            text-decoration: none;
            font-weight: 900;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #fff;
            color: #fff;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #fff;
            color: #000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #1a1a1a;
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 5px;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
            color: #000;
            border: none;
        }

        .link-section {
            background: #1a1a1a;
            border: 3px solid #fff;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .link-section h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .link-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #000;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .link-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1rem;
            outline: none;
        }

        .copy-btn {
            background: #fff;
            color: #000;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: #4CAF50;
            color: #fff;
        }

        .sales-section {
            background: #1a1a1a;
            border: 3px solid #fff;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .sales-section h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .status-confirmed {
            color: #4CAF50;
            font-weight: 700;
        }

        .status-paid {
            color: #2196F3;
            font-weight: 700;
        }

        .status-pending {
            color: #FFC107;
            font-weight: 700;
        }

        .promo-section {
            background: #1a1a1a;
            border: 3px solid #fff;
            border-radius: 10px;
            padding: 30px;
        }

        .promo-section h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .promo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .promo-card {
            background: #000;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
        }

        .promo-card h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .promo-card p {
            font-size: 0.9rem;
            line-height: 1.6;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
        }

        .error {
            background: #ff0000;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .my-rank-row {
            background: #2a2a2a;
            border: 2px solid #fff;
            font-weight: 900;
        }

        .top-3 {
            font-size: 1.3rem;
        }

        .rank-medal {
            font-size: 1.5rem;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .link-box {
                flex-direction: column;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <span class="fleur">‚öúÔ∏è</span>
            <h1>FRENCH CONNEXION‚Ñ¢</h1>
            <p class="subtitle">Dashboard Affili√©</p>
        </header>

        <div id="loading" class="loading">
            Chargement de tes stats...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="not-affiliate" class="not-affiliate" style="display: none;">
            <h2>Tu n'es pas encore affili√©</h2>
            <p>Rejoins le programme d'affiliation French Connexion‚Ñ¢ et gagne 10‚Ç¨ par vente.</p>
            <button onclick="becomeAffiliate()" class="btn">Devenir Affili√©</button>
            <a href="reader.html" class="btn btn-secondary">Retour √† l'Ebook</a>
        </div>

        <div id="dashboard" style="display: none;">
            <!-- Navigation rapide -->
            <div style="text-align: center; margin-bottom: 30px;">
                <a href="affiliate-training.html" class="btn" style="margin: 5px;">üéì Formation</a>
                <a href="affiliate-content-library.html" class="btn" style="margin: 5px;">üìö 40+ Scripts</a>
                <a href="affiliate-kit.html" class="btn btn-secondary" style="margin: 5px;">üé® Guides</a>
                <a href="affiliate-rules.html" class="btn btn-secondary" style="margin: 5px;">üìã R√®gles</a>
                <a href="reader.html" class="btn btn-secondary" style="margin: 5px;">üìñ Ebook</a>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Clics</h3>
                    <div class="value" id="totalClicks">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ventes</h3>
                    <div class="value" id="totalSales">0</div>
                </div>
                <div class="stat-card highlight">
                    <h3>Commission Gagn√©e</h3>
                    <div class="value" id="totalCommission">0‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <h3>Pay√©</h3>
                    <div class="value" id="totalPaid">0‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <h3>En Attente</h3>
                    <div class="value" id="pending">0‚Ç¨</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);">
                    <h3>üèÜ Ma Position</h3>
                    <div class="value" id="myRank">-</div>
                </div>
            </div>

            <!-- Lien affili√© -->
            <div class="link-section">
                <h2>üîó Ton Lien Affili√©</h2>
                <div class="link-box">
                    <input type="text" id="affiliateLink" readonly>
                    <button class="copy-btn" onclick="copyLink()">Copier</button>
                </div>
                <p style="opacity: 0.7; font-size: 0.9rem;">Partage ce lien sur tes r√©seaux sociaux, par email, etc. Tu gagnes 10‚Ç¨ (50%) pour chaque vente.</p>
            </div>

            <!-- Ventes r√©centes -->
            <div class="sales-section">
                <h2>üìä Ventes R√©centes</h2>
                <div id="salesTable">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Email</th>
                                <th>Montant</th>
                                <th>Commission</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody id="salesBody">
                            <tr>
                                <td colspan="5" style="text-align: center; opacity: 0.5;">Aucune vente pour le moment</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Classement -->
            <div class="sales-section">
                <h2>üèÜ Top 20 Affili√©s</h2>
                <p style="opacity: 0.7; margin-bottom: 20px;">Les meilleurs performeurs du programme</p>
                <div id="leaderboardTable">
                    <table>
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Nom</th>
                                <th>Code</th>
                                <th>Ventes</th>
                                <th>Commission</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <tr>
                                <td colspan="5" style="text-align: center; opacity: 0.5;">Chargement du classement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mat√©riel promo -->
            <div class="promo-section">
                <h2>üé® Mat√©riel Promo</h2>
                <p style="opacity: 0.7; margin-bottom: 20px;">Utilise ces textes pour promouvoir French Connexion‚Ñ¢</p>
                <div class="promo-grid">
                    <div class="promo-card">
                        <h3>Instagram/Facebook</h3>
                        <p>üí™ J'ai lu French Connexion‚Ñ¢ et √ßa a chang√© ma vision du business.<br><br>Ce n'est pas du bullshit motivationnel. C'est brutal, direct, actionnable.<br><br>Si tu veux lancer ton business sans excuses:<br>[TON LIEN]<br><br>‚öúÔ∏è French Connexion‚Ñ¢<br>Pour les 1% qui n'ont besoin de personne.</p>
                        <button class="copy-btn" onclick="copyPromo('instagram')">Copier</button>
                    </div>
                    <div class="promo-card">
                        <h3>Twitter/X</h3>
                        <p>J'ai lu French Connexion‚Ñ¢. Pas de bullshit. Juste la v√©rit√© brutale sur l'entrepreneuriat.<br><br>Si tu veux lancer ton business: [LIEN]<br><br>‚öúÔ∏è Pour les 1% qui n'ont besoin de personne.</p>
                        <button class="copy-btn" onclick="copyPromo('twitter')">Copier</button>
                    </div>
                    <div class="promo-card">
                        <h3>Email</h3>
                        <p><strong>Objet:</strong> Le seul ebook business sans bullshit<br><br>Salut,<br><br>Si tu en as marre des gourous qui vendent du r√™ve et des formations √† 2000‚Ç¨, French Connexion‚Ñ¢ c'est diff√©rent.<br><br>C'est brutal. C'est honn√™te. √áa marche.<br><br>[Clique ici pour le d√©couvrir]<br><br>PS: "Papa n'ach√®te pas le v√©lo" - tu comprendras en lisant.</p>
                        <button class="copy-btn" onclick="copyPromo('email')">Copier</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API URL dynamique
        function getApiUrl() {
            const hostname = window.location.hostname;

            // D√©veloppement local
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3000/api';
            }

            // Production - utiliser le m√™me domaine que le frontend avec /api
            return `${window.location.origin}/api`;
        }

        const API_URL = getApiUrl();
        let affiliateData = null;

        // V√©rifier l'authentification
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Session invalide');
                }

                await loadAffiliateData();
            } catch (error) {
                console.error('Erreur auth:', error);
                localStorage.removeItem('auth_token');
                window.location.href = 'login.html';
            }
        }

        // Charger les donn√©es affili√©
        async function loadAffiliateData() {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/affiliate/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 404) {
                    // Pas encore affili√©
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('not-affiliate').style.display = 'block';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Erreur lors du chargement');
                }

                const data = await response.json();
                affiliateData = data;

                displayDashboard(data);
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = 'Erreur lors du chargement des donn√©es.';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Afficher le dashboard
        function displayDashboard(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Stats
            document.getElementById('totalClicks').textContent = data.stats.total_clicks || 0;
            document.getElementById('totalSales').textContent = data.stats.total_sales || 0;
            document.getElementById('totalCommission').textContent = `${data.stats.total_commission || 0}‚Ç¨`;
            document.getElementById('totalPaid').textContent = `${data.stats.total_paid || 0}‚Ç¨`;
            document.getElementById('pending').textContent = `${data.stats.pending || 0}‚Ç¨`;

            // Lien affili√©
            document.getElementById('affiliateLink').value = data.affiliate.link;

            // Ventes r√©centes
            if (data.recent_sales && data.recent_sales.length > 0) {
                const tbody = document.getElementById('salesBody');
                tbody.innerHTML = '';

                data.recent_sales.forEach(sale => {
                    const row = document.createElement('tr');
                    const date = new Date(sale.created_at).toLocaleDateString('fr-FR');
                    const statusClass = sale.status === 'paid' ? 'status-paid' :
                                       sale.status === 'confirmed' ? 'status-confirmed' :
                                       'status-pending';
                    const statusText = sale.status === 'paid' ? 'Pay√©' :
                                      sale.status === 'confirmed' ? 'Confirm√©' :
                                      'En attente';

                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${sale.buyer_email}</td>
                        <td>${sale.amount}‚Ç¨</td>
                        <td>${sale.commission}‚Ç¨</td>
                        <td class="${statusClass}">${statusText}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Charger classement et position
            loadLeaderboard();
            loadMyRank();
        }

        // Charger le classement
        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_URL}/affiliate/leaderboard`);
                if (!response.ok) throw new Error('Erreur chargement classement');

                const data = await response.json();
                const tbody = document.getElementById('leaderboardBody');
                tbody.innerHTML = '';

                if (data.leaderboard && data.leaderboard.length > 0) {
                    data.leaderboard.forEach((affiliate, index) => {
                        const row = document.createElement('tr');
                        const position = index + 1;
                        const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : '';
                        const isMyCode = affiliateData?.affiliate?.code === affiliate.affiliate_code;

                        row.className = isMyCode ? 'my-rank-row' : '';
                        row.innerHTML = `
                            <td class="${position <= 3 ? 'top-3' : ''}">
                                ${medal ? `<span class="rank-medal">${medal}</span>` : `#${position}`}
                            </td>
                            <td>${affiliate.name || 'Anonyme'}</td>
                            <td>${affiliate.affiliate_code}</td>
                            <td>${affiliate.total_sales || 0}</td>
                            <td>${affiliate.total_commission || 0}‚Ç¨</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.5;">Aucun affili√© pour le moment</td></tr>';
                }
            } catch (error) {
                console.error('Erreur chargement classement:', error);
            }
        }

        // Charger ma position
        async function loadMyRank() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/affiliate/my-rank`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erreur chargement position');

                const data = await response.json();
                const medal = data.rank === 1 ? 'ü•á' : data.rank === 2 ? 'ü•à' : data.rank === 3 ? 'ü•â' : '';
                document.getElementById('myRank').textContent = `${medal} #${data.rank}`;
            } catch (error) {
                console.error('Erreur chargement position:', error);
                document.getElementById('myRank').textContent = '-';
            }
        }

        // Devenir affili√©
        async function becomeAffiliate() {
            const token = localStorage.getItem('token');

            if (!token) {
                alert('‚ùå Tu dois √™tre connect√© pour devenir affili√©.\n\nRedirection vers la page de connexion...');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/affiliate/register`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();

                    // Si session invalide, proposer de se reconnecter
                    if (error.error && error.error.includes('invalide')) {
                        if (confirm('‚ùå Ta session a expir√©.\n\nVeux-tu te reconnecter ?')) {
                            localStorage.removeItem('token');
                            window.location.href = 'login.html';
                        }
                        return;
                    }

                    throw new Error(error.error || 'Erreur lors de l\'inscription');
                }

                const data = await response.json();
                alert('‚úÖ ' + data.message + '\n\nTon code: ' + data.affiliate.code);

                // Recharger la page
                window.location.reload();
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå ' + error.message);
            }
        }

        // Copier le lien
        function copyLink() {
            const input = document.getElementById('affiliateLink');
            input.select();
            document.execCommand('copy');

            const btn = event.target;
            btn.textContent = '‚úì Copi√© !';
            btn.classList.add('copied');

            setTimeout(() => {
                btn.textContent = 'Copier';
                btn.classList.remove('copied');
            }, 2000);
        }

        // Copier texte promo
        function copyPromo(type) {
            const link = document.getElementById('affiliateLink').value;
            let text = '';

            if (type === 'instagram') {
                text = `üí™ J'ai lu French Connexion‚Ñ¢ et √ßa a chang√© ma vision du business.

Ce n'est pas du bullshit motivationnel. C'est brutal, direct, actionnable.

Si tu veux lancer ton business sans excuses:
${link}

‚öúÔ∏è French Connexion‚Ñ¢
Pour les 1% qui n'ont besoin de personne.`;
            } else if (type === 'twitter') {
                text = `J'ai lu French Connexion‚Ñ¢. Pas de bullshit. Juste la v√©rit√© brutale sur l'entrepreneuriat.

Si tu veux lancer ton business: ${link}

‚öúÔ∏è Pour les 1% qui n'ont besoin de personne.`;
            } else if (type === 'email') {
                text = `Objet: Le seul ebook business sans bullshit

Salut,

Si tu en as marre des gourous qui vendent du r√™ve et des formations √† 2000‚Ç¨, French Connexion‚Ñ¢ c'est diff√©rent.

C'est brutal. C'est honn√™te. √áa marche.

${link}

PS: "Papa n'ach√®te pas le v√©lo" - tu comprendras en lisant.`;
            }

            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                btn.textContent = '‚úì Copi√© !';
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.textContent = 'Copier';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Au chargement de la page
        checkAuth();
    </script>
</body>
</html>
